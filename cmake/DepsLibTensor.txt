#
#   Set up third-party dependencies for libtensor
#

include(CheckCXXSourceCompiles)

#   Detect whether the system is POSIX-compliant
#
if(UNIX)
    add_definitions(-DPOSIX)
endif(UNIX)

#   Test drand48
#
check_cxx_source_compiles("
#include<cstdlib>
int main() {
  double d = drand48();
  return 0;
}
" HAVE_DRAND48)
if(HAVE_DRAND48)
    add_definitions(-DHAVE_DRAND48)
endif(HAVE_DRAND48)

#   Bug in gcc prior to 4.8 (http://gcc.gnu.org/bugzilla/show_bug.cgi?id=50080)
#
check_cxx_source_compiles("
template<typename T> struct A { template<typename P> void f() { } };
int main() {
  A<int> a;
  a.template f<int>();
  return 0;
}
" GCC_BUG_REJECTS_TEMPLATE_OUTSIDE_TEMPLATE)

#   Detect the linear algebra library
#
if(WITH_BLAS STREQUAL "mkl")
    set(CMAKE_MODULE_PATH_SAVED ${CMAKE_MODULE_PATH})
    set(CMAKE_MODULE_PATH ${LIBTENSOR_DIR}/cmake)
    find_package(MKL)
    set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH_SAVED})
    if(NOT MKL_FOUND)
        message(FATAL_ERROR "Intel MKL library not found")
    endif(NOT MKL_FOUND)
    set(BLAS_LAPACK_INCLUDE ${MKL_INCLUDE_PATH})
    set(BLAS_LAPACK_LINKER_FLAGS "")
    set(BLAS_LAPACK_LIBRARIES ${MKL_LIBRARIES})
elseif(WITH_BLAS STREQUAL "acml")
    set(CMAKE_MODULE_PATH_SAVED ${CMAKE_MODULE_PATH})
    set(CMAKE_MODULE_PATH ${LIBTENSOR_DIR}/cmake)
    find_package(ACML)
    set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH_SAVED})
    if(NOT ACML_FOUND)
        message(FATAL_ERROR "ACML library not found")
    endif(NOT ACML_FOUND)
    set(BLAS_LAPACK_INCLUDE ${ACML_INCLUDE_PATH})
    set(BLAS_LAPACK_LINKER_FLAGS "")
    set(BLAS_LAPACK_LIBRARIES "${ACML_LIBRARIES}")
elseif(WITH_BLAS STREQUAL "essl")
    set(CMAKE_MODULE_PATH_SAVED ${CMAKE_MODULE_PATH})
    set(CMAKE_MODULE_PATH ${LIBTENSOR_DIR}/cmake)
    find_package(ESSL)
    set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH_SAVED})
    if(NOT ESSL_FOUND)
        message(FATAL_ERROR "ESSL not found")
    endif(NOT ESSL_FOUND)
    set(BLAS_LAPACK_INCLUDE "")
    set(BLAS_LAPACK_LINKER_FLAGS "")
    set(BLAS_LAPACK_LIBRARIES "${ESSL_LIBRARIES}")
elseif(WITH_BLAS STREQUAL "atlas")
    set(CMAKE_MODULE_PATH_SAVED ${CMAKE_MODULE_PATH})
    set(CMAKE_MODULE_PATH ${LIBTENSOR_DIR}/cmake)
    find_package(ATLAS)
    set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH_SAVED})
    if(NOT ATLAS_FOUND)
        message(FATAL_ERROR "ATLAS library not found")
    endif(NOT ATLAS_FOUND)
    set(BLAS_LAPACK_INCLUDE "")
    set(BLAS_LAPACK_LINKER_FLAGS "")
    set(BLAS_LAPACK_LIBRARIES "${ATLAS_LIBRARIES}")
elseif(WITH_BLAS STREQUAL "openblas")
    set(CMAKE_MODULE_PATH_SAVED ${CMAKE_MODULE_PATH})
    set(CMAKE_MODULE_PATH ${LIBTENSOR_DIR}/cmake)
    find_package(OpenBLAS)
    set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH_SAVED})
    if(NOT OPENBLAS_FOUND)
        message(FATAL_ERROR "OpenBLAS library not found")
    endif(NOT OPENBLAS_FOUND)
    set(BLAS_LAPACK_INCLUDE ${OPENBLAS_INCLUDE_PATH})
    set(BLAS_LAPACK_LINKER_FLAGS "")
    set(BLAS_LAPACK_LIBRARIES ${OPENBLAS_LIBRARIES})
else()
    find_package(LAPACK REQUIRED)
    set(BLAS_LAPACK_INCLUDE "")
    set(BLAS_LAPACK_LINKER_FLAGS ${LAPACK_LINKER_FLAGS})
    set(BLAS_LAPACK_LIBRARIES ${LAPACK_LIBRARIES})
endif()

#   Libtensor dependencies (libraries)
#
include_directories(${BLAS_LAPACK_INCLUDE})
set(LIBTENSOR_DEP_LIBS ${BLAS_LAPACK_LIBRARIES})

