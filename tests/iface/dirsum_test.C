#include <libtensor/core/scalar_transf_double.h>
#include <libtensor/block_tensor/bto_add.h>
#include <libtensor/block_tensor/bto_copy.h>
#include <libtensor/block_tensor/bto_dirsum.h>
#include <libtensor/block_tensor/bto_random.h>
#include <libtensor/block_tensor/bto_set.h>
#include <libtensor/libtensor.h>
#include "../test_utils.h"
#include "../compare_ref.h"

using namespace libtensor;


int test_tt_1() {

    static const char testname[] = "dirsum_test::test_tt_1()";

    try {

    bispace<1> sp_i(10), sp_a(20);
    bispace<2> sp_ia(sp_i|sp_a);

    btensor<1> t1(sp_i);
    btensor<1> t2(sp_a);
    btensor<2> t3(sp_ia), t3_ref(sp_ia);

    bto_random<1, double>().perform(t1);
    bto_random<1, double>().perform(t2);
    t1.set_immutable();
    t2.set_immutable();

    bto_dirsum<1, 1, double>(t1, 1.0, t2, 1.0).perform(t3_ref);

    letter i, a;
    t3(i|a) = dirsum(t1(i), t2(a));

    compare_ref<2>::compare(testname, t3, t3_ref, 1e-15);

    } catch(exception &e) {
        return fail_test(testname, __FILE__, __LINE__, e.what());
    }

    return 0;
}


int test_tt_2() {

    static const char testname[] = "dirsum_test::test_tt_2()";

    try {

    bispace<1> sp_i(10), sp_a(20);
    bispace<2> sp_ij(sp_i&sp_i), sp_ab(sp_a&sp_a);
    bispace<4> sp_ijab((sp_i&sp_i)|(sp_a&sp_a));

    btensor<2> t1(sp_ij);
    btensor<2> t2(sp_ab);
    btensor<4> t3(sp_ijab), t3_ref(sp_ijab);

    bto_random<2, double>().perform(t1);
    bto_random<2, double>().perform(t2);
    t1.set_immutable();
    t2.set_immutable();

    bto_dirsum<2, 2, double>(t1, 1.0, t2, 1.0).perform(t3_ref);

    letter i, j, a, b;
    t3(i|j|a|b) = dirsum(t1(i|j), t2(a|b));

    compare_ref<4>::compare(testname, t3, t3_ref, 1e-15);

    } catch(exception &e) {
        return fail_test(testname, __FILE__, __LINE__, e.what());
    }

    return 0;
}


int test_tt_3() {

    static const char testname[] = "dirsum_test::test_tt_3()";

    try {

    bispace<1> sp_i(10), sp_a(20);
    bispace<1> sp_j(sp_i), sp_b(sp_a);
    bispace<2> sp_ij(sp_i&sp_j), sp_ab(sp_a&sp_b);
    bispace<4> sp_iajb(sp_i|sp_a|sp_j|sp_b, (sp_i&sp_j)|(sp_a&sp_b));

    btensor<2> t1(sp_ij);
    btensor<2> t2(sp_ab);
    btensor<4> t3(sp_iajb), t3_ref(sp_iajb);

    bto_random<2, double>().perform(t1);
    bto_random<2, double>().perform(t2);
    t1.set_immutable();
    t2.set_immutable();

    permutation<4> perm3;
    perm3.permute(1, 2); // ijab->iajb
    bto_dirsum<2, 2, double>(t1, 1.0, t2, 1.0, perm3).perform(t3_ref);

    letter i, j, a, b;
    t3(i|a|j|b) = dirsum(t1(i|j), t2(a|b));

    compare_ref<4>::compare(testname, t3, t3_ref, 1e-15);

    } catch(exception &e) {
        return fail_test(testname, __FILE__, __LINE__, e.what());
    }

    return 0;
}


int test_tt_4() {

    static const char testname[] = "dirsum_test::test_tt_4()";

    try {

    bispace<1> sp_i(10), sp_a(20);
    bispace<2> sp_ij(sp_i&sp_i), sp_ab(sp_a&sp_a);
    bispace<4> sp_ijab((sp_i&sp_i)|(sp_a&sp_a));

    btensor<2> t1(sp_ij);
    btensor<2> t2(sp_ab);
    btensor<4> t3(sp_ijab), t3_ref(sp_ijab);

    bto_random<2, double>().perform(t1);
    bto_random<2, double>().perform(t2);
    t1.set_immutable();
    t2.set_immutable();

    bto_dirsum<2, 2, double>(t1, 2.0, t2, -1.0).perform(t3_ref);

    letter i, j, a, b;
    t3(i|j|a|b) = dirsum(2.0 * t1(i|j), -t2(a|b));

    compare_ref<4>::compare(testname, t3, t3_ref, 1e-15);

    } catch(exception &e) {
        return fail_test(testname, __FILE__, __LINE__, e.what());
    }

    return 0;
}


int test_tt_5() {

    static const char testname[] = "dirsum_test::test_tt_5()";

    try {

    bispace<1> sp_i(10), sp_a(20);
    bispace<1> sp_j(sp_i), sp_b(sp_a);
    bispace<2> sp_ij(sp_i&sp_j), sp_ab(sp_a&sp_b);
    bispace<4> sp_iajb(sp_i|sp_a|sp_j|sp_b, (sp_i&sp_j)|(sp_a&sp_b));

    btensor<2> t1(sp_ij);
    btensor<2> t2(sp_ab);
    btensor<4> t3(sp_iajb), t3_ref(sp_iajb);

    bto_random<2, double>().perform(t1);
    bto_random<2, double>().perform(t2);
    t1.set_immutable();
    t2.set_immutable();

    permutation<4> perm3;
    perm3.permute(1, 2); // ijab->iajb
    bto_dirsum<2, 2, double>(t1, -1.5, t2, 1.0, perm3).perform(t3_ref);

    letter i, j, a, b;
    t3(i|a|j|b) = 0.5 * dirsum(-3.0 * t1(i|j), 2.0 * t2(a|b));

    compare_ref<4>::compare(testname, t3, t3_ref, 1e-15);

    } catch(exception &e) {
        return fail_test(testname, __FILE__, __LINE__, e.what());
    }

    return 0;
}


int test_tt_6() {

    static const char testname[] = "dirsum_test::test_tt_6()";

    try {

    bispace<1> sp_i(10);
    sp_i.split(5);
    bispace<2> sp_ij(sp_i&sp_i);

    btensor<1> t1(sp_i);
    btensor<2> t2(sp_ij), t2_ref(sp_ij);

    bto_random<1, double>().perform(t1);
    t1.set_immutable();

    bto_dirsum<1, 1, double>(t1, 2.0, t1, -2.0).perform(t2_ref);

    letter i, j;
    t2(i|j) = dirsum(2.0 * t1(i), -2.0 * t1(j));

    compare_ref<2>::compare(testname, t2, t2_ref, 1e-15);

    } catch(exception &e) {
        return fail_test(testname, __FILE__, __LINE__, e.what());
    }

    return 0;
}



int test_te_1() {

    static const char testname[] = "dirsum_test::test_te_1()";

    try {

    bispace<1> sp_i(10), sp_a(20);
    bispace<2> sp_ia(sp_i|sp_a);

    btensor<1> t1(sp_i);
    btensor<1> t21(sp_a), t22(sp_a), t2(sp_a);
    btensor<2> t3(sp_ia), t3_ref(sp_ia);

    bto_random<1, double>().perform(t1);
    bto_random<1, double>().perform(t21);
    bto_random<1, double>().perform(t22);
    t1.set_immutable();
    t21.set_immutable();
    t22.set_immutable();

    bto_add<1, double> add2(t21, 1.0);
    add2.add_op(t22, 1.0);
    add2.perform(t2);
    t2.set_immutable();

    bto_set<2, double>(1.0).perform(t3);
    bto_set<2, double>(1.0).perform(t3_ref);

    bto_dirsum<1, 1, double>(t1, 1.0, t2, 1.0).perform(t3_ref);

    letter i, a;
    t3(i|a) = dirsum(t1(i), t21(a) + t22(a));

    compare_ref<2>::compare(testname, t3, t3_ref, 1e-15);

    } catch(exception &e) {
        return fail_test(testname, __FILE__, __LINE__, e.what());
    }

    return 0;
}


int test_te_2() {

    static const char testname[] = "dirsum_test::test_te_2()";

    try {

    bispace<1> sp_i(10);
    sp_i.split(5);
    bispace<2> sp_ij(sp_i&sp_i);

    btensor<1> t1(sp_i);
    btensor<2> t2(sp_ij), t2_ref(sp_ij);

    bto_random<1, double>().perform(t1);
    t1.set_immutable();

    bto_dirsum<1, 1, double>(t1, 1.0, t1, -1.0).perform(t2_ref);

    letter i, j;
    t2(i|j) = dirsum(t1(i), -t1(j));

    compare_ref<2>::compare(testname, t2, t2_ref, 1e-15);

    } catch(exception &e) {
        return fail_test(testname, __FILE__, __LINE__, e.what());
    }

    return 0;
}


int test_et_1() {

    static const char testname[] = "dirsum_test::test_et_1()";

    try {

    bispace<1> sp_i(10), sp_a(20);
    bispace<2> sp_ia(sp_i|sp_a);

    btensor<1> t11(sp_i), t12(sp_i), t1(sp_i);
    btensor<1> t2(sp_a);
    btensor<2> t3(sp_ia), t3_ref(sp_ia);

    bto_random<1, double>().perform(t11);
    bto_random<1, double>().perform(t12);
    bto_random<1, double>().perform(t2);
    t11.set_immutable();
    t12.set_immutable();
    t2.set_immutable();

    bto_add<1, double> add1(t11, 1.0);
    add1.add_op(t12, 1.0);
    add1.perform(t1);
    bto_dirsum<1, 1, double>(t1, 1.0, t2, 1.0).perform(t3_ref);

    letter i, a;
    t3(i|a) = dirsum(t11(i) + t12(i), t2(a));

    compare_ref<2>::compare(testname, t3, t3_ref, 1e-15);

    } catch(exception &e) {
        return fail_test(testname, __FILE__, __LINE__, e.what());
    }

    return 0;
}


int test_et_2() {

    static const char testname[] = "dirsum_test::test_et_2()";

    try {

    bispace<1> sp_i(10);
    sp_i.split(5);
    bispace<2> sp_ij(sp_i&sp_i);

    btensor<1> t1(sp_i);
    btensor<2> t2(sp_ij), t2_ref(sp_ij);

    bto_random<1, double>().perform(t1);
    t1.set_immutable();

    bto_dirsum<1, 1, double>(t1, -1.0, t1, 1.0).perform(t2_ref);

    letter i, j;
    t2(i|j) = dirsum(-t1(i), t1(j));

    compare_ref<2>::compare(testname, t2, t2_ref, 1e-15);

    } catch(exception &e) {
        return fail_test(testname, __FILE__, __LINE__, e.what());
    }

    return 0;
}


int test_ee_1() {

    static const char testname[] = "dirsum_test::test_ee_1()";

    try {

    bispace<1> sp_i(10), sp_a(20);
    bispace<2> sp_ia(sp_i|sp_a);

    btensor<1> t11(sp_i), t12(sp_i), t1(sp_i);
    btensor<1> t21(sp_a), t22(sp_a), t2(sp_a);
    btensor<2> t3(sp_ia), t3_ref(sp_ia);

    bto_random<1, double>().perform(t11);
    bto_random<1, double>().perform(t12);
    bto_random<1, double>().perform(t21);
    bto_random<1, double>().perform(t22);
    t11.set_immutable();
    t12.set_immutable();
    t21.set_immutable();
    t22.set_immutable();

    bto_add<1, double> add1(t11, 1.0);
    add1.add_op(t12, 1.0);
    add1.perform(t1);
    bto_add<1, double> add2(t21, 1.0);
    add2.add_op(t22, 1.0);
    add2.perform(t2);
    bto_dirsum<1, 1, double>(t1, 1.0, t2, 1.0).perform(t3_ref);

    letter i, a;
    t3(i|a) = dirsum(t11(i) + t12(i), t21(a) + t22(a));

    compare_ref<2>::compare(testname, t3, t3_ref, 1e-15);

    } catch(exception &e) {
        return fail_test(testname, __FILE__, __LINE__, e.what());
    }

    return 0;
}


int main() {

    allocator::init(16, 16, 16777216, 16777216);

    int rc =
        test_tt_1() |
        test_tt_2() |
        test_tt_3() |
        test_tt_4() |
        test_tt_5() |
        test_tt_6() |
        test_te_1() |
        test_te_2() |
        test_et_1() |
        test_et_2() |
        test_ee_1() |
        0;

    allocator::shutdown();
    return rc;
}

